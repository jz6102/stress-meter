import 'dart:async';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:speech_to_text/speech_to_text.dart' as stt;
import 'package:camera/camera.dart';
import 'package:google_mlkit_face_detection/google_mlkit_face_detection.dart';
import 'package:dart_sentiment/dart_sentiment.dart';
import 'package:tflite_flutter/tflite_flutter.dart';
import 'package:translator/translator.dart';

const Map<String, String> languageNames = {
  'en': 'English',
  'hi': 'рд╣рд┐рдиреНрджреА',
  'ta': 'родрооро┐ро┤рпН',
  'te': 'р░др▒Жр░▓р▒Бр░Чр▒Б',
  'ml': 'р┤ор┤▓р┤пр┤╛р┤│р┤В',
  'kn': 'р▓Хр▓ир│Нр▓ир▓б',
};

// Define keywords for stress levels in each language
// final Map<String, Map<String, List<String>>> languageKeywordStressLevels = {
//   'en': {
//     'High Stress ЁЯШЯ': [
//       'i want to die',
//       'i am very stressed',
//       'i can\'t handle this',
//     ],
//     'Moderate Stress ЁЯШР': ['i am in stress', 'i feel anxious', 'i need help'],
//     'Low Stress ЁЯШК': ['i am feeling good', 'i am happy', 'everything is fine'],
//   },
//   'hi': {
//     'High Stress ЁЯШЯ': [
//       'рдореЗрд░рд╛ рдЬреАрдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддрд╛',
//       'рдореЗрд░рд╛ рдмрд╣реБрдд рддрдирд╛рд╡',
//       'рдореЗрд░рд╛ рдЗрд╕реЗ рдирд╣реАрдВ рдХрд░ рдкрд╛ рд░рд╣рд╛',
//     ],
//     'Moderate Stress ЁЯШР': ['рдореЗрд░реЗ рдкрд╛рд╕ рддрдирд╛рд╡', 'рдореЗрд░рд╛ рдЪрд┐рдВрддрд┐рдд', 'рдореЗрд░рд╛ рдорджрдж рдЪрд╛рд╣рддрд╛'],

//     'Low Stress ЁЯШК': ['рдореЗрд░рд╛ рдЕрдЪреНрдЫрд╛ рд▓рдЧ рд░рд╣рд╛', 'рдореЗрд░рд╛ рдЦрд╝реБрд╢', 'рд╕рд╛рд░рд╛ рдХрд╛рд░реНрдп рдареАрдХ'],
//   },
//   'ta': {
//     'High Stress ЁЯШЯ': [], // Add Tamil keywords here
//     'Moderate Stress ЁЯШР': [],
//     'Low Stress ЁЯШК': [],
//   },
//   'te': {
//     'High Stress ЁЯШЯ': [], // Add Telugu keywords here
//     'Moderate Stress ЁЯШР': [],
//     'Low Stress ЁЯШК': [],
//   },
//   'ml': {
//     'High Stress ЁЯШЯ': [], // Add Malayalam keywords here
//     'Moderate Stress ЁЯШР': [],
//     'Low Stress ЁЯШК': [],
//   },
//   'kn': {
//     'High Stress ЁЯШЯ': [], // Add Kannada keywords here
//     'Moderate Stress ЁЯШР': [],
//     'Low Stress ЁЯШК': [],
//   },
// };

// // Order of stress levels for priority checking (high to low)
// const List<String> stressLevelsOrder = [
//   'High Stress ЁЯШЯ',
//   'Moderate Stress ЁЯШР',
//   'Low Stress ЁЯШК',
// ];

final Map<String, Map<String, List<String>>> languageKeywordStressLevels = {
  'en': {
    'High Stress ЁЯШЯ': [
      'i want to die',
      'i am very stressed',
      'i can\'t handle this',
    ],
    'Moderate Stress ЁЯШР': ['i am in stress', 'i feel anxious', 'i need help'],
    'Low Stress ЁЯШК': ['i am feeling good', 'i am happy', 'everything is fine'],
  },
  'hi': {
    'High Stress ЁЯШЯ': [
      'рдореЗрд░рд╛ рдЬреАрдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддрд╛', // "I donтАЩt want to live"
      'рдореЗрд░рд╛ рдмрд╣реБрдд рддрдирд╛рд╡', // "I have a lot of stress"
      'рдореЗрд░рд╛ рдЗрд╕реЗ рдирд╣реАрдВ рдХрд░ рдкрд╛ рд░рд╣рд╛', // "I canтАЩt do this"
    ],
    'Moderate Stress ЁЯШР': [
      'рдореЗрд░реЗ рдкрд╛рд╕ рддрдирд╛рд╡', // "I have stress"
      'рдореЗрд░рд╛ рдЪрд┐рдВрддрд┐рдд', // "I am worried"
      'рдореЗрд░рд╛ рдорджрдж рдЪрд╛рд╣рддрд╛', // "I want help"
    ],
    'Low Stress ЁЯШК': [
      'рдореЗрд░рд╛ рдЕрдЪреНрдЫрд╛ рд▓рдЧ рд░рд╣рд╛', // "I am feeling good"
      'рдореЗрд░рд╛ рдЦрд╝реБрд╢', // "I am happy"
      'рд╕рд╛рд░рд╛ рдХрд╛рд░реНрдп рдареАрдХ', // "Everything is fine"
    ],
  },
  'ta': {
    'High Stress ЁЯШЯ': [
      'роиро╛ройрпН роЪро╛роХ ро╡ро┐ро░рпБроорпНрокрпБроХро┐ро▒рпЗройрпН', // "I want to die"
      'роиро╛ройрпН рооро┐роХро╡рпБроорпН роорой роЕро┤рпБродрпНродродрпНродро┐ро▓рпН роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН', // "I am very stressed"
      'роОройрпНройро╛ро▓рпН роЗродрпИ роЪрооро╛ро│ро┐роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ', // "I canтАЩt handle this"
    ],
    'Moderate Stress ЁЯШР': [
      'роиро╛ройрпН роорой роЕро┤рпБродрпНродродрпНродро┐ро▓рпН роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН', // "I am in stress"
      'роиро╛ройрпН рокродроЯрпНроЯрооро╛роХ роЙрогро░рпНроХро┐ро▒рпЗройрпН', // "I feel anxious"
      'роОройроХрпНроХрпБ роЙродро╡ро┐ родрпЗро╡рпИ', // "I need help"
    ],
    'Low Stress ЁЯШК': [
      'роиро╛ройрпН роиройрпНро▒ро╛роХ роЙрогро░рпНроХро┐ро▒рпЗройрпН', // "I am feeling good"
      'роиро╛ройрпН роороХро┐ро┤рпНроЪрпНроЪро┐ропро╛роХ роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН', // "I am happy"
      'роОро▓рпНро▓ро╛роорпН роЪро░ро┐ропро╛роХ роЗро░рпБроХрпНроХро┐ро▒родрпБ', // "Everything is fine"
    ],
  },
  'te': {
    'High Stress ЁЯШЯ': [
      'р░ир▒Зр░ир▒Б р░Ър░ир░┐р░кр▒Лр░╡р░╛р░▓р░ир▒Бр░Хр▒Бр░Вр░Яр▒Бр░ир▒Нр░ир░╛р░ир▒Б', // "I want to die"
      'р░ир▒Зр░ир▒Б р░Ър░╛р░▓р░╛ р░Тр░др▒Нр░др░┐р░бр░┐р░▓р▒Л р░Йр░ир▒Нр░ир░╛р░ир▒Б', // "I am very stressed"
      'р░ир▒Зр░ир▒Б р░жр▒Ар░ир▒Нр░ир░┐ р░╕р░╛р░зр░┐р░Вр░Ър░▓р▒Зр░ир▒Б', // "I canтАЩt handle this"
    ],
    'Moderate Stress ЁЯШР': [
      'р░ир▒Зр░ир▒Б р░Тр░др▒Нр░др░┐р░бр░┐р░▓р▒Л р░Йр░ир▒Нр░ир░╛р░ир▒Б', // "I am in stress"
      'р░ир░╛р░Хр▒Б р░Жр░Вр░жр▒Лр░│р░ир░Чр░╛ р░Йр░Вр░жр░┐', // "I feel anxious"
      'р░ир░╛р░Хр▒Б р░╕р░╣р░╛р░пр░В р░Хр░╛р░╡р░╛р░▓р░┐', // "I need help"
    ],
    'Low Stress ЁЯШК': [
      'р░ир▒Зр░ир▒Б р░мр░╛р░Чр░╛ р░Йр░ир▒Нр░ир░╛р░ир▒Б', // "I am feeling good"
      'р░ир▒Зр░ир▒Б р░╕р░Вр░др▒Лр░╖р░Вр░Чр░╛ р░Йр░ир▒Нр░ир░╛р░ир▒Б', // "I am happy"
      'р░Ер░Вр░др░╛ р░мр░╛р░Чр▒Бр░Вр░жр░┐', // "Everything is fine"
    ],
  },
  'ml': {
    'High Stress ЁЯШЯ': [
      'р┤Юр┤╛р╡╗ р┤ор┤░р┤┐р┤Хр╡Нр┤Хр┤╛р╡╗ р┤Жр┤Чр╡Нр┤░р┤╣р┤┐р┤Хр╡Нр┤Хр╡Бр┤ир╡Нр┤ир╡Б', // "I want to die"
      'р┤Юр┤╛р╡╗ р┤╡р┤│р┤░р╡Ж р┤╕р┤ор╡Нр┤ор╡╝р┤жр╡Нр┤жр┤др╡Нр┤др┤┐р╡╜ р┤Жр┤гр╡Н', // "I am very stressed"
      'р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤Зр┤др╡Н р┤Хр╡Ир┤Хр┤╛р┤░р╡Нр┤пр┤В р┤Ър╡Жр┤пр╡Нр┤пр┤╛р╡╗ р┤Хр┤┤р┤┐р┤пр┤┐р┤▓р╡Нр┤▓', // "I canтАЩt handle this"
    ],
    'Moderate Stress ЁЯШР': [
      'р┤Юр┤╛р╡╗ р┤╕р┤ор╡Нр┤ор╡╝р┤жр╡Нр┤жр┤др╡Нр┤др┤┐р╡╜ р┤Жр┤гр╡Н', // "I am in stress"
      'р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤Йр┤др╡Нр┤Хр┤гр╡Нр┤а р┤др╡Лр┤ир╡Нр┤ир╡Бр┤ир╡Нр┤ир╡Б', // "I feel anxious"
      'р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤╕р┤╣р┤╛р┤пр┤В р┤╡р╡Зр┤гр┤В', // "I need help"
    ],
    'Low Stress ЁЯШК': [
      'р┤Юр┤╛р╡╗ р┤ир┤▓р╡Нр┤▓р┤др┤╛р┤пр┤┐ р┤др╡Лр┤ир╡Нр┤ир╡Бр┤ир╡Нр┤ир╡Б', // "I am feeling good"
      'р┤Юр┤╛р╡╗ р┤╕р┤ир╡Нр┤др╡Лр┤╖р┤╡р┤╛р┤ир┤╛р┤гр╡Н', // "I am happy"
      'р┤Ор┤▓р╡Нр┤▓р┤╛р┤В р┤╢р┤░р┤┐р┤пр┤╛р┤гр╡Н', // "Everything is fine"
    ],
  },
  'kn': {
    'High Stress ЁЯШЯ': [
      'р▓ир▓╛р▓ир│Б р▓╕р▓╛р▓пр▓▓р│Б р▓мр▓пр▓╕р│Бр▓др│Нр▓др│Зр▓ир│Ж', // "I want to die"
      'р▓ир▓╛р▓ир│Б р▓др│Бр▓Вр▓мр▓╛ р▓Тр▓др│Нр▓др▓бр▓жр▓▓р│Нр▓▓р▓┐ р▓Зр▓жр│Нр▓жр│Зр▓ир│Ж', // "I am very stressed"
      'р▓ир▓ир▓Чр│Ж р▓Зр▓жр▓ир│Нр▓ир│Б р▓ир▓┐р▓нр▓╛р▓пр▓┐р▓╕р▓▓р│Б р▓╕р▓╛р▓зр│Нр▓пр▓╡р▓┐р▓▓р│Нр▓▓', // "I canтАЩt handle this"
    ],
    'Moderate Stress ЁЯШР': [
      'р▓ир▓╛р▓ир│Б р▓Тр▓др│Нр▓др▓бр▓жр▓▓р│Нр▓▓р▓┐ р▓Зр▓жр│Нр▓жр│Зр▓ир│Ж', // "I am in stress"
      'р▓ир▓ир▓Чр│Ж р▓Жр▓др▓Вр▓Хр▓╡р▓╛р▓Чр│Бр▓др│Нр▓др▓┐р▓жр│Ж', // "I feel anxious"
      'р▓ир▓ир▓Чр│Ж р▓╕р▓╣р▓╛р▓п р▓мр│Зр▓Хр│Б', // "I need help"
    ],
    'Low Stress ЁЯШК': [
      'р▓ир▓╛р▓ир│Б р▓Ър│Жр▓ир│Нр▓ир▓╛р▓Чр▓┐ р▓нр▓╛р▓╡р▓┐р▓╕р│Бр▓др│Нр▓др│Зр▓ир│Ж', // "I am feeling good"
      'р▓ир▓╛р▓ир│Б р▓╕р▓Вр▓др│Лр▓╖р▓╡р▓╛р▓Чр▓┐р▓жр│Нр▓жр│Зр▓ир│Ж', // "I am happy"
      'р▓Ор▓▓р│Нр▓▓р▓╡р│В р▓╕р▓░р▓┐р▓пр▓╛р▓Чр▓┐р▓жр│Ж', // "Everything is fine"
    ],
  },
};
// Order of stress levels for priority checking (high to low)
const List<String> stressLevelsOrder = [
  'High Stress ЁЯШЯ',
  'Moderate Stress ЁЯШР',
  'Low Stress ЁЯШК',
];

class VoiceFaceAnalysis extends StatefulWidget {
  const VoiceFaceAnalysis({super.key});

  @override
  State<VoiceFaceAnalysis> createState() => _VoiceFaceAnalysisState();
}

class _VoiceFaceAnalysisState extends State<VoiceFaceAnalysis> {
  late stt.SpeechToText _speech;
  CameraController? _cameraController;
  late FaceDetector _faceDetector;
  Interpreter? _interpreter;
  bool _isAnalyzing = false;
  String _detectedText = "";
  String _stressLevel = "Press Start to Analyze";
  String _currentEmotion = "Neutral ЁЯШР";
  final _sentiment = Sentiment();
  String _selectedLanguage = 'en';
  final _translator = GoogleTranslator();
  Timer? _analysisTimer;
  final _speechBuffer = StringBuffer();
  DateTime? _lastSpeechUpdate;

  @override
  void initState() {
    super.initState();
    _initializeServices();
  }

  Future<void> _initializeServices() async {
    _speech = stt.SpeechToText();
    await _initializeCamera();
    _faceDetector = FaceDetector(
      options: FaceDetectorOptions(
        enableClassification: true,
        performanceMode: FaceDetectorMode.fast,
      ),
    );
    await _loadModel();
  }

  Future<void> _initializeCamera() async {
    try {
      final cameras = await availableCameras();
      final frontCamera = cameras.firstWhere(
        (c) => c.lensDirection == CameraLensDirection.front,
      );

      _cameraController = CameraController(
        frontCamera,
        ResolutionPreset.low,
        enableAudio: false,
      );

      await _cameraController!.initialize();
      if (mounted) setState(() {});
    } catch (e) {
      debugPrint('Camera Error: $e');
    }
  }

  Future<void> _loadModel() async {
    try {
      _interpreter = await Interpreter.fromAsset('assets/fer2013_model.tflite');
      _interpreter!.allocateTensors();
    } catch (e) {
      debugPrint('Model Error: $e');
    }
  }

  Future<void> _toggleAnalysis() async {
    if (_isAnalyzing) {
      await _stopAnalysis();
    } else {
      await _startAnalysis();
    }
  }

  Future<void> _startAnalysis() async {
    _speechBuffer.clear();
    setState(() {
      _isAnalyzing = true;
      _stressLevel = "Analyzing...";
      _detectedText = "";
    });

    if (await _speech.initialize()) {
      _speech.listen(
        onResult: (result) {
          if (result.recognizedWords.isNotEmpty) {
            final now = DateTime.now();
            if (_lastSpeechUpdate == null ||
                now.difference(_lastSpeechUpdate!) >
                    const Duration(milliseconds: 200)) {
              _lastSpeechUpdate = now;
              _speechBuffer.write('${result.recognizedWords} ');
              setState(() => _detectedText = _speechBuffer.toString());
            }
          }
        },
        localeId: _getLocaleId(),
        listenFor: const Duration(minutes: 5),
        listenOptions: stt.SpeechListenOptions(
          cancelOnError: true,
          listenMode: stt.ListenMode.confirmation,
        ),
      );
    }

    _analysisTimer = Timer.periodic(const Duration(seconds: 1), (timer) async {
      if (!_isAnalyzing) {
        timer.cancel();
        return;
      }
      await _analyzeStress();
    });
  }

  Future<void> _stopAnalysis() async {
    _speech.stop();
    _analysisTimer?.cancel();
    await _analyzeStress();
    setState(() => _isAnalyzing = false);
    _speechBuffer.clear();
  }

  // Normalize text for consistent keyword matching
  String normalizeText(String text) {
    return text.toLowerCase().replaceAll(RegExp(r'[\.,!?]'), '');
  }

  // Check if text contains a keyword sequence
  bool containsKeyword(String text, String keyword) {
    final textWords = text.split(' ');
    final keywordWords = keyword.split(' ');
    int textIndex = 0;
    for (final kwWord in keywordWords) {
      while (textIndex < textWords.length && textWords[textIndex] != kwWord) {
        textIndex++;
      }
      if (textIndex == textWords.length) {
        return false;
      }
      textIndex++;
    }
    return true;
  }

  Future<void> _analyzeStress() async {
    try {
      final text = _detectedText;
      if (text.isEmpty) return;

      // Check for keywords first
      final normalizedText = normalizeText(text);
      final language = _selectedLanguage;
      final keywords = languageKeywordStressLevels[language];

      if (keywords != null) {
        for (final stressLevel in stressLevelsOrder) {
          for (final keyword in keywords[stressLevel]!) {
            if (containsKeyword(normalizedText, keyword)) {
              setState(() => _stressLevel = stressLevel);
              return;
            }
          }
        }
      }

      // Fallback to standard analysis if no keywords match
      final translatedText = await _translateToEnglish(text);
      final sentiment = _sentiment.analysis(translatedText);
      final faceStress = _calculateFaceStress();
      final voiceStress = _calculateVoiceStress(text);

      final totalScore =
          (sentiment['score']?.abs() ?? 0) * 2 + faceStress * 1.5 + voiceStress;

      final newStressLevel = _getStressLevel(totalScore);
      setState(() => _stressLevel = newStressLevel);
    } catch (e) {
      debugPrint('Stress analysis error: $e');
    }
  }

  String _getStressLevel(double totalScore) {
    if (totalScore > 15) return "Critical Stress ЁЯШ▒";
    if (totalScore > 10) return "High Stress ЁЯШЯ";
    if (totalScore > 5) return "Moderate Stress ЁЯШР";
    return "Low Stress ЁЯШК";
  }

  double _calculateFaceStress() {
    return switch (_currentEmotion) {
      "High Stress ЁЯШЯ" => 4.0,
      "Moderate Stress ЁЯШР" => 2.5,
      _ => 1.0,
    };
  }

  double _calculateVoiceStress(String text) {
    final wordCount = text.split(' ').length;
    final sentiment = _sentiment.analysis(text);
    final baseScore =
        wordCount > 50
            ? 3.0
            : wordCount > 25
            ? 2.0
            : 1.0;
    return baseScore * (sentiment['comparative']?.abs() ?? 1.0);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text(
          "ЁЯОд Voice & ЁЯУ╕ Face Stress Analysis",
          style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black),
        ),
        backgroundColor: Colors.white,
        elevation: 10,
        actions: [
          DropdownButton<String>(
            value: _selectedLanguage,
            items:
                languageNames.entries
                    .map(
                      (entry) => DropdownMenuItem<String>(
                        value: entry.key,
                        child: Text(entry.value),
                      ),
                    )
                    .toList(),
            onChanged: (value) => setState(() => _selectedLanguage = value!),
          ),
        ],
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            colors: [
              Color.fromARGB(255, 38, 6, 93),
              Color.fromARGB(255, 61, 29, 127),
              Color.fromARGB(255, 41, 35, 75),
            ],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: SingleChildScrollView(
          child: ConstrainedBox(
            constraints: BoxConstraints(
              minHeight: MediaQuery.of(context).size.height,
            ),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                if (_cameraController != null &&
                    _cameraController!.value.isInitialized)
                  SizedBox(
                    height: 300,
                    width: 300,
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(20),
                      child: CameraPreview(_cameraController!),
                    ),
                  )
                else
                  const Padding(
                    padding: EdgeInsets.all(40.0),
                    child: CircularProgressIndicator(color: Colors.white),
                  ),
                const SizedBox(height: 30),
                ElevatedButton(
                  onPressed: _toggleAnalysis,
                  style: ElevatedButton.styleFrom(
                    backgroundColor:
                        _isAnalyzing ? Colors.red : Colors.lightGreen,
                    padding: const EdgeInsets.symmetric(
                      horizontal: 40,
                      vertical: 15,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(30),
                    ),
                  ),
                  child: Text(
                    _isAnalyzing ? "тП╣ Stop Analysis" : "тЦ╢ Start Analysis",
                    style: const TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.black,
                    ),
                  ),
                ),
                const SizedBox(height: 30),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 25.0),
                  child: Container(
                    padding: const EdgeInsets.all(20),
                    margin: const EdgeInsets.only(bottom: 20),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(15),
                    ),
                    child: Column(
                      children: [
                        Text(
                          "Detected Text: $_detectedText",
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontSize: 18,
                            color: Colors.white,
                          ),
                        ),
                        const SizedBox(height: 20),
                        Text(
                          _stressLevel,
                          style: const TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                        const SizedBox(height: 15),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 10.0),
                          child: Text(
                            _getStressDialog(_stressLevel),
                            textAlign: TextAlign.center,
                            style: TextStyle(
                              fontSize: 16,
                              color: Colors.amber.shade200,
                              fontStyle: FontStyle.italic,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  String _getStressDialog(String stressLevel) {
    return switch (stressLevel) {
      "Low Stress ЁЯШК" =>
        "ЁЯМЯ Great! You seem relaxed and in control. Maintain this positive state!",
      "Moderate Stress ЁЯШР" =>
        "ЁЯТб You're handling things well, but consider taking short mindful breaks.",
      "High Stress ЁЯШЯ" =>
        "тЪая╕П Noticeable stress detected. Try deep breathing or a quick walk.",
      "Critical Stress ЁЯШ▒" =>
        "ЁЯЪи High stress levels detected! Please consider seeking support.",
      _ => "ЁЯМ▒ Take a moment to focus on your well-being.",
    };
  }

  @override
  void dispose() {
    _cameraController?.dispose();
    _faceDetector.close();
    _interpreter?.close();
    _analysisTimer?.cancel();
    super.dispose();
  }

  String _getLocaleId() => '$_selectedLanguage-IN';

  Future<String> _translateToEnglish(String text) async {
    if (_selectedLanguage == 'en' || text.isEmpty) return text;
    try {
      return (await _translator.translate(text, to: 'en')).text;
    } catch (e) {
      return text;
    }
  }
}

void main() {
  runApp(const MaterialApp(home: VoiceFaceAnalysis()));
}








// import 'dart:async';
// import 'dart:typed_data';
// import 'package:flutter/material.dart';
// import 'package:speech_to_text/speech_to_text.dart' as stt;
// import 'package:camera/camera.dart';
// import 'package:google_mlkit_face_detection/google_mlkit_face_detection.dart';
// import 'package:dart_sentiment/dart_sentiment.dart';
// import 'package:tflite_flutter/tflite_flutter.dart';
// import 'package:translator/translator.dart';

// const Map<String, String> languageNames = {
//   'en': 'English',
//   'hi': 'рд╣рд┐рдиреНрджреА',
//   'ta': 'родрооро┐ро┤рпН',
//   'te': 'р░др▒Жр░▓р▒Бр░Чр▒Б',
//   'ml': 'р┤ор┤▓р┤пр┤╛р┤│р┤В',
//   'kn': 'р▓Хр▓ир│Нр▓ир▓б',
// };

// class VoiceFaceAnalysis extends StatefulWidget {
//   const VoiceFaceAnalysis({super.key});

//   @override
//   State<VoiceFaceAnalysis> createState() => _VoiceFaceAnalysisState();
// }

// class _VoiceFaceAnalysisState extends State<VoiceFaceAnalysis> {
//   late stt.SpeechToText _speech;
//   CameraController? _cameraController;
//   late FaceDetector _faceDetector;
//   Interpreter? _interpreter;
//   bool _isAnalyzing = false;
//   String _detectedText = "";
//   String _stressLevel = "Press Start to Analyze";
//   String _currentEmotion = "Neutral ЁЯШР";
//   final _sentiment = Sentiment();
//   String _selectedLanguage = 'en';
//   final _translator = GoogleTranslator();
//   Timer? _analysisTimer;
//   final _speechBuffer = StringBuffer();
//   DateTime? _lastSpeechUpdate;

//   @override
//   void initState() {
//     super.initState();
//     _initializeServices();
//   }

//   Future<void> _initializeServices() async {
//     _speech = stt.SpeechToText();
//     await _initializeCamera();
//     _faceDetector = FaceDetector(
//       options: FaceDetectorOptions(
//         enableClassification: true,
//         performanceMode: FaceDetectorMode.fast,
//       ),
//     );
//     await _loadModel();
//   }

//   Future<void> _initializeCamera() async {
//     try {
//       final cameras = await availableCameras();
//       final frontCamera = cameras.firstWhere(
//         (c) => c.lensDirection == CameraLensDirection.front,
//       );

//       _cameraController = CameraController(
//         frontCamera,
//         ResolutionPreset.low,
//         enableAudio: false,
//       );

//       await _cameraController!.initialize();
//       if (mounted) setState(() {});
//     } catch (e) {
//       debugPrint('Camera Error: $e');
//     }
//   }

//   Future<void> _loadModel() async {
//     try {
//       _interpreter = await Interpreter.fromAsset('assets/fer2013_model.tflite');
//       _interpreter!.allocateTensors();
//     } catch (e) {
//       debugPrint('Model Error: $e');
//     }
//   }

//   Future<void> _toggleAnalysis() async {
//     if (_isAnalyzing) {
//       await _stopAnalysis();
//     } else {
//       await _startAnalysis();
//     }
//   }

//   Future<void> _startAnalysis() async {
//     _speechBuffer.clear();
//     setState(() {
//       _isAnalyzing = true;
//       _stressLevel = "Analyzing...";
//       _detectedText = "";
//     });

//     if (await _speech.initialize()) {
//       _speech.listen(
//         onResult: (result) {
//           if (result.recognizedWords.isNotEmpty) {
//             final now = DateTime.now();
//             if (_lastSpeechUpdate == null ||
//                 now.difference(_lastSpeechUpdate!) >
//                     const Duration(milliseconds: 200)) {
//               _lastSpeechUpdate = now;
//               _speechBuffer.write('${result.recognizedWords} ');
//               setState(() => _detectedText = _speechBuffer.toString());
//             }
//           }
//         },
//         localeId: _getLocaleId(),
//         listenFor: const Duration(minutes: 5),
//         listenOptions: stt.SpeechListenOptions(
//           cancelOnError: true,
//           listenMode: stt.ListenMode.confirmation,
//         ),
//       );
//     }

//     _analysisTimer = Timer.periodic(const Duration(seconds: 1), (timer) async {
//       if (!_isAnalyzing) {
//         timer.cancel();
//         return;
//       }
//       await _analyzeStress();
//     });
//   }

//   Future<void> _stopAnalysis() async {
//     _speech.stop();
//     _analysisTimer?.cancel();
//     await _analyzeStress();
//     setState(() => _isAnalyzing = false);
//     _speechBuffer.clear();
//   }

//   Future<void> _analyzeStress() async {
//     try {
//       final text = _detectedText;
//       if (text.isEmpty) return;

//       final translatedText = await _translateToEnglish(text);
//       final sentiment = _sentiment.analysis(translatedText);
//       final faceStress = _calculateFaceStress();
//       final voiceStress = _calculateVoiceStress(text);

//       final totalScore =
//           (sentiment['score']?.abs() ?? 0) * 2 + faceStress * 1.5 + voiceStress;

//       final newStressLevel = _getStressLevel(totalScore);
//       setState(() => _stressLevel = newStressLevel);
//     } catch (e) {
//       debugPrint('Stress analysis error: $e');
//     }
//   }

//   String _getStressLevel(double totalScore) {
//     if (totalScore > 15) return "Critical Stress ЁЯШ▒";
//     if (totalScore > 10) return "High Stress ЁЯШЯ";
//     if (totalScore > 5) return "Moderate Stress ЁЯШР";
//     return "Low Stress ЁЯШК";
//   }

//   double _calculateFaceStress() {
//     return switch (_currentEmotion) {
//       "High Stress ЁЯШЯ" => 4.0,
//       "Moderate Stress ЁЯШР" => 2.5,
//       _ => 1.0,
//     };
//   }

//   double _calculateVoiceStress(String text) {
//     final wordCount = text.split(' ').length;
//     final sentiment = _sentiment.analysis(text);
//     final baseScore =
//         wordCount > 50
//             ? 3.0
//             : wordCount > 25
//             ? 2.0
//             : 1.0;
//     return baseScore * (sentiment['comparative']?.abs() ?? 1.0);
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       appBar: AppBar(
//         title: const Text(
//           "ЁЯОд Voice & ЁЯУ╕ Face Stress Analysis",
//           style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black),
//         ),
//         backgroundColor: Colors.white,
//         elevation: 10,
//         actions: [
//           DropdownButton<String>(
//             value: _selectedLanguage,
//             items:
//                 languageNames.entries
//                     .map(
//                       (entry) => DropdownMenuItem<String>(
//                         value: entry.key,
//                         child: Text(entry.value),
//                       ),
//                     )
//                     .toList(),
//             onChanged: (value) => setState(() => _selectedLanguage = value!),
//           ),
//         ],
//       ),
//       body: Container(
//         decoration: const BoxDecoration(
//           gradient: LinearGradient(
//             colors: [
//               Color.fromARGB(255, 38, 6, 93),
//               Color.fromARGB(255, 61, 29, 127),
//               Color.fromARGB(255, 41, 35, 75),
//             ],
//             begin: Alignment.topCenter,
//             end: Alignment.bottomCenter,
//           ),
//         ),
//         child: SingleChildScrollView(
//           child: ConstrainedBox(
//             constraints: BoxConstraints(
//               minHeight: MediaQuery.of(context).size.height,
//             ),
//             child: Column(
//               mainAxisAlignment: MainAxisAlignment.center,
//               children: [
//                 if (_cameraController != null &&
//                     _cameraController!.value.isInitialized)
//                   SizedBox(
//                     height: 300,
//                     width: 300,
//                     child: ClipRRect(
//                       borderRadius: BorderRadius.circular(20),
//                       child: CameraPreview(_cameraController!),
//                     ),
//                   )
//                 else
//                   const Padding(
//                     padding: EdgeInsets.all(40.0),
//                     child: CircularProgressIndicator(color: Colors.white),
//                   ),
//                 const SizedBox(height: 30),
//                 ElevatedButton(
//                   onPressed: _toggleAnalysis,
//                   style: ElevatedButton.styleFrom(
//                     backgroundColor:
//                         _isAnalyzing ? Colors.red : Colors.lightGreen,
//                     padding: const EdgeInsets.symmetric(
//                       horizontal: 40,
//                       vertical: 15,
//                     ),
//                     shape: RoundedRectangleBorder(
//                       borderRadius: BorderRadius.circular(30),
//                     ),
//                   ),
//                   child: Text(
//                     _isAnalyzing ? "тП╣ Stop Analysis" : "тЦ╢ Start Analysis",
//                     style: const TextStyle(
//                       fontSize: 20,
//                       fontWeight: FontWeight.bold,
//                       color: Colors.black,
//                     ),
//                   ),
//                 ),
//                 const SizedBox(height: 30),
//                 Padding(
//                   padding: const EdgeInsets.symmetric(horizontal: 25.0),
//                   child: Container(
//                     padding: const EdgeInsets.all(20),
//                     margin: const EdgeInsets.only(bottom: 20),
//                     decoration: BoxDecoration(
//                       color: Colors.white.withOpacity(0.1),
//                       borderRadius: BorderRadius.circular(15),
//                     ),
//                     child: Column(
//                       children: [
//                         Text(
//                           "Detected Text: $_detectedText",
//                           textAlign: TextAlign.center,
//                           style: const TextStyle(
//                             fontSize: 18,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 20),
//                         Text(
//                           _stressLevel,
//                           style: const TextStyle(
//                             fontSize: 24,
//                             fontWeight: FontWeight.bold,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 15),
//                         Padding(
//                           padding: const EdgeInsets.symmetric(horizontal: 10.0),
//                           child: Text(
//                             _getStressDialog(_stressLevel),
//                             textAlign: TextAlign.center,
//                             style: TextStyle(
//                               fontSize: 16,
//                               color: Colors.amber.shade200,
//                               fontStyle: FontStyle.italic,
//                             ),
//                           ),
//                         ),
//                       ],
//                     ),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//         ),
//       ),
//     );
//   }

//   String _getStressDialog(String stressLevel) {
//     return switch (stressLevel) {
//       "Low Stress ЁЯШК" =>
//         "ЁЯМЯ Great! You seem relaxed and in control. Maintain this positive state!",
//       "Moderate Stress ЁЯШР" =>
//         "ЁЯТб You're handling things well, but consider taking short mindful breaks.",
//       "High Stress ЁЯШЯ" =>
//         "тЪая╕П Noticeable stress detected. Try deep breathing or a quick walk.",
//       "Critical Stress ЁЯШ▒" =>
//         "ЁЯЪи High stress levels detected! Please consider seeking support.",
//       _ => "ЁЯМ▒ Take a moment to focus on your well-being.",
//     };
//   }

//   @override
//   void dispose() {
//     _cameraController?.dispose();
//     _faceDetector.close();
//     _interpreter?.close();
//     _analysisTimer?.cancel();
//     super.dispose();
//   }

//   String _getLocaleId() => '$_selectedLanguage-IN';

//   Future<String> _translateToEnglish(String text) async {
//     if (_selectedLanguage == 'en' || text.isEmpty) return text;
//     try {
//       return (await _translator.translate(text, to: 'en')).text;
//     } catch (e) {
//       return text;
//     }
//   }
// }










// import 'dart:io';
// import 'dart:typed_data';
// import 'package:flutter/material.dart';
// import 'package:speech_to_text/speech_to_text.dart' as stt;
// import 'package:camera/camera.dart';
// import 'package:google_mlkit_face_detection/google_mlkit_face_detection.dart';
// import 'package:dart_sentiment/dart_sentiment.dart';
// import 'package:tflite_flutter/tflite_flutter.dart';
// import 'package:image/image.dart' as img;
// import 'package:translator/translator.dart';

// const Map<String, String> languageNames = {
//   'en': 'English',
//   'hi': 'рд╣рд┐рдиреНрджреА',
//   'ta': 'родрооро┐ро┤рпН',
//   'te': 'р░др▒Жр░▓р▒Бр░Чр▒Б',
//   'ml': 'р┤ор┤▓р┤пр┤╛р┤│р┤В',
//   'kn': 'р▓Хр▓ир│Нр▓ир▓б',
// };

// class VoiceFaceAnalysis extends StatefulWidget {
//   const VoiceFaceAnalysis({super.key});

//   @override
//   _VoiceFaceAnalysisState createState() => _VoiceFaceAnalysisState();
// }

// class _VoiceFaceAnalysisState extends State<VoiceFaceAnalysis> {
//   late stt.SpeechToText _speech;
//   CameraController? _cameraController;
//   late FaceDetector _faceDetector;
//   Interpreter? _interpreter;
//   bool _isAnalyzing = false;
//   String _detectedText = "";
//   String _stressLevel = "Press Start to Analyze";
//   DateTime? _lastProcessingTime;
//   final _sentiment = Sentiment();
//   final List<String> _emotions = [
//     "Angry ЁЯШб",
//     "Disgust ЁЯдв",
//     "Fear ЁЯШи",
//     "Happy ЁЯШК",
//     "Neutral ЁЯШР",
//     "Sad ЁЯШн",
//     "Surprise ЁЯШ▓",
//   ];
//   String _selectedLanguage = 'en';
//   final _translator = GoogleTranslator();

//   @override
//   void initState() {
//     super.initState();
//     _initializeServices();
//   }

//   Future<void> _initializeServices() async {
//     _speech = stt.SpeechToText();
//     await _initializeCamera();
//     _faceDetector = FaceDetector(
//       options: FaceDetectorOptions(
//         enableClassification: true,
//         performanceMode: FaceDetectorMode.fast,
//       ),
//     );
//     await _loadModel();
//   }

//   Future<void> _initializeCamera() async {
//     try {
//       final cameras = await availableCameras();
//       final frontCamera = cameras.firstWhere(
//         (c) => c.lensDirection == CameraLensDirection.front,
//       );

//       _cameraController = CameraController(
//         frontCamera,
//         ResolutionPreset.low,
//         enableAudio: false,
//       );

//       await _cameraController!.initialize();
//       if (mounted) setState(() {});
//     } catch (e) {
//       debugPrint('Camera Error: $e');
//     }
//   }

//   Future<void> _loadModel() async {
//     try {
//       _interpreter = await Interpreter.fromAsset('assets/fer2013_model.tflite');
//       _interpreter!.allocateTensors();
//     } catch (e) {
//       debugPrint('Model Error: $e');
//     }
//   }

//   Future<void> _toggleAnalysis() async {
//     if (_isAnalyzing) {
//       await _stopAnalysis();
//     } else {
//       await _startAnalysis();
//     }
//   }

//   Future<void> _startAnalysis() async {
//     setState(() {
//       _isAnalyzing = true;
//       _stressLevel = "Analyzing...";
//       _detectedText = "";
//     });

//     if (await _speech.initialize()) {
//       _speech.listen(
//         onResult: (result) {
//           if (result.finalResult) {
//             setState(() => _detectedText = result.recognizedWords);
//           }
//         },
//         localeId: _getLocaleId(),
//         listenFor: const Duration(minutes: 5),
//         cancelOnError: true,
//       );
//     }

//     _cameraController?.startImageStream((image) {
//       if (_isAnalyzing &&
//           (_lastProcessingTime == null ||
//               DateTime.now().difference(_lastProcessingTime!) >
//                   const Duration(milliseconds: 500))) {
//         _processFrame(image);
//         _lastProcessingTime = DateTime.now();
//       }
//     });
//   }

//   String _getLocaleId() {
//     switch (_selectedLanguage) {
//       case 'hi':
//         return 'hi-IN';
//       case 'ta':
//         return 'ta-IN';
//       case 'te':
//         return 'te-IN';
//       case 'ml':
//         return 'ml-IN';
//       case 'kn':
//         return 'kn-IN';
//       default:
//         return 'en-US';
//     }
//   }

//   Future<void> _stopAnalysis() async {
//     _speech.stop();
//     _cameraController?.stopImageStream();
//     final result = await _calculateStress();
//     setState(() {
//       _isAnalyzing = false;
//       _stressLevel = result;
//     });
//   }

//   Future<void> _processFrame(CameraImage image) async {
//     try {
//       final inputImage = InputImage.fromBytes(
//         bytes: _concatImagePlanes(image.planes),
//         inputImageData: InputImageData(
//           size: Size(image.width.toDouble(), image.height.toDouble()),
//           imageRotation: InputImageRotation.rotation0deg,
//           inputImageFormat: InputImageFormat.nv21,
//           planeData:
//               image.planes
//                   .map(
//                     (plane) => InputImagePlaneMetadata(
//                       bytesPerRow: plane.bytesPerRow,
//                       height: plane.height,
//                       width: plane.width,
//                     ),
//                   )
//                   .toList(),
//         ),
//       );

//       final faces = await _faceDetector.processImage(inputImage);
//       if (faces.isNotEmpty) setState(() {});
//     } catch (e) {
//       debugPrint('Frame Processing Error: $e');
//     }
//   }

//   Uint8List _concatImagePlanes(List<Plane> planes) {
//     final bytes = <int>[];
//     for (final plane in planes) {
//       bytes.addAll(plane.bytes);
//     }
//     return Uint8List.fromList(bytes);
//   }

//   Future<String> _calculateStress() async {
//     int stressScore = 0;
//     String textToAnalyze = _detectedText;

//     try {
//       if (_selectedLanguage != 'en') {
//         textToAnalyze = await _translateToEnglish(_detectedText);
//       }

//       final textScore = _sentiment.analysis(textToAnalyze)['score'] ?? 0;
//       if (textScore < 0) stressScore += 1;

//       final imageFile = File((await _cameraController!.takePicture()).path);
//       final processedImage = img.copyResize(
//         img.decodeImage(imageFile.readAsBytesSync())!,
//         width: 48,
//         height: 48,
//       );

//       final input = _prepareModelInput(processedImage);
//       final output = List.filled(7, 0.0).reshape([1, 7]);
//       _interpreter?.run(input, output);

//       final emotionIndex = output[0].indexOf(
//         output[0].reduce((a, b) => a > b ? a : b),
//       );
//       if (![
//         "Happy ЁЯШК",
//         "Neutral ЁЯШР",
//         "Surprise ЁЯШ▓",
//       ].contains(_emotions[emotionIndex])) {
//         stressScore += 1;
//       }
//     } catch (e) {
//       debugPrint('Stress Calculation Error: $e');
//     }

//     return _getStressLevel(stressScore);
//   }

//   Future<String> _translateToEnglish(String text) async {
//     if (_selectedLanguage == 'en') return text;
//     try {
//       Translation translation = await _translator.translate(text, to: 'en');
//       return translation.text;
//     } catch (e) {
//       debugPrint('Translation error: $e');
//       return text;
//     }
//   }

//   String _getStressLevel(int score) {
//     return score == 0
//         ? "Low Stress ЁЯШК"
//         : score == 1
//         ? "Moderate Stress ЁЯШР"
//         : "High Stress ЁЯШЯ";
//   }

//   String _getStressDialog(String stressLevel) {
//     switch (stressLevel) {
//       case "Low Stress ЁЯШК":
//         return "ЁЯМЯ Great! You seem to be handling things well. Keep up the positive mindset!";
//       case "Moderate Stress ЁЯШР":
//         return "ЁЯТб You're doing okay, but consider taking short breaks. Practice deep breathing or a quick walk.";
//       case "High Stress ЁЯШЯ":
//         return "тЪая╕П It's important to take care of yourself. Try relaxation techniques or talk to someone.";
//       default:
//         return "ЁЯМ▒ Take a moment to assess your well-being. Your health matters!";
//     }
//   }

//   List<List<List<List<double>>>> _prepareModelInput(img.Image image) {
//     return List.generate(
//       1,
//       (_) => List.generate(
//         48,
//         (y) => List.generate(48, (x) {
//           final pixel = image.getPixel(x, y);
//           return [(pixel.r + pixel.g + pixel.b) / 3.0 / 255.0];
//         }),
//       ),
//     );
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       appBar: AppBar(
//         title: const Text(
//           "ЁЯОд Voice & ЁЯУ╕ Face Stress Analysis",
//           style: TextStyle(fontWeight: FontWeight.bold, color: Colors.black),
//         ),
//         backgroundColor: Colors.white,
//         elevation: 10,
//         actions: [
//           DropdownButton<String>(
//             value: _selectedLanguage,
//             items:
//                 languageNames.entries.map((entry) {
//                   return DropdownMenuItem(
//                     value: entry.key,
//                     child: Text(entry.value),
//                   );
//                 }).toList(),
//             onChanged: (value) => setState(() => _selectedLanguage = value!),
//           ),
//         ],
//       ),
//       body: Container(
//         decoration: const BoxDecoration(
//           gradient: LinearGradient(
//             colors: [
//               Color.fromARGB(255, 38, 6, 93),
//               Color.fromARGB(255, 61, 29, 127),
//               Color.fromARGB(255, 41, 35, 75),
//             ],
//             begin: Alignment.topCenter,
//             end: Alignment.bottomCenter,
//           ),
//         ),
//         child: SingleChildScrollView(
//           child: ConstrainedBox(
//             constraints: BoxConstraints(
//               minHeight: MediaQuery.of(context).size.height,
//             ),
//             child: Column(
//               mainAxisAlignment: MainAxisAlignment.center,
//               children: [
//                 _cameraController != null &&
//                         _cameraController!.value.isInitialized
//                     ? SizedBox(
//                       height: 300,
//                       width: 300,
//                       child: ClipRRect(
//                         borderRadius: BorderRadius.circular(20),
//                         child: CameraPreview(_cameraController!),
//                       ),
//                     )
//                     : const Padding(
//                       padding: EdgeInsets.all(40.0),
//                       child: CircularProgressIndicator(color: Colors.white),
//                     ),
//                 const SizedBox(height: 30),
//                 ElevatedButton(
//                   onPressed: _toggleAnalysis,
//                   style: ElevatedButton.styleFrom(
//                     backgroundColor: Colors.lightGreen,
//                     padding: const EdgeInsets.symmetric(
//                       horizontal: 40,
//                       vertical: 15,
//                     ),
//                     shape: RoundedRectangleBorder(
//                       borderRadius: BorderRadius.circular(30),
//                     ),
//                   ),
//                   child: Text(
//                     _isAnalyzing ? "тП╣ Stop Analysis" : "тЦ╢ Start Analysis",
//                     style: const TextStyle(
//                       fontSize: 20,
//                       fontWeight: FontWeight.bold,
//                       color: Colors.black,
//                     ),
//                   ),
//                 ),
//                 const SizedBox(height: 30),
//                 Padding(
//                   padding: const EdgeInsets.symmetric(horizontal: 25.0),
//                   child: Container(
//                     padding: const EdgeInsets.all(20),
//                     margin: const EdgeInsets.only(bottom: 20),
//                     decoration: BoxDecoration(
//                       color: Colors.white.withOpacity(0.1),
//                       borderRadius: BorderRadius.circular(15),
//                     ),
//                     child: Column(
//                       children: [
//                         Text(
//                           "Detected Text: $_detectedText",
//                           textAlign: TextAlign.center,
//                           style: const TextStyle(
//                             fontSize: 18,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 20),
//                         Text(
//                           _stressLevel,
//                           style: const TextStyle(
//                             fontSize: 24,
//                             fontWeight: FontWeight.bold,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 15),
//                         Padding(
//                           padding: const EdgeInsets.symmetric(horizontal: 10.0),
//                           child: Text(
//                             _getStressDialog(_stressLevel),
//                             textAlign: TextAlign.center,
//                             style: TextStyle(
//                               fontSize: 16,
//                               color: Colors.amber[200],
//                               fontStyle: FontStyle.italic,
//                             ),
//                           ),
//                         ),
//                       ],
//                     ),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//         ),
//       ),
//     );
//   }

//   @override
//   void dispose() {
//     _cameraController?.dispose();
//     _faceDetector.close();
//     _interpreter?.close();
//     super.dispose();
//   }
// }




// Original code = 
// import 'dart:io';
// import 'dart:typed_data';
// import 'package:flutter/material.dart';
// import 'package:speech_to_text/speech_to_text.dart' as stt;
// import 'package:camera/camera.dart';
// import 'package:google_mlkit_face_detection/google_mlkit_face_detection.dart';
// import 'package:dart_sentiment/dart_sentiment.dart';
// import 'package:tflite_flutter/tflite_flutter.dart';
// import 'package:image/image.dart' as img;

// class VoiceFaceAnalysis extends StatefulWidget {
//   const VoiceFaceAnalysis({super.key});

//   @override
//   _VoiceFaceAnalysisState createState() => _VoiceFaceAnalysisState();
// }

// class _VoiceFaceAnalysisState extends State<VoiceFaceAnalysis> {
//   late stt.SpeechToText _speech;
//   CameraController? _cameraController;
//   late FaceDetector _faceDetector;
//   Interpreter? _interpreter;
//   bool _isAnalyzing = false;
//   String _detectedText = "";
//   String _stressLevel = "Press Start to Analyze";
//   DateTime? _lastProcessingTime;
//   final _sentiment = Sentiment();
//   final List<String> _emotions = [
//     "Angry ЁЯШб",
//     "Disgust ЁЯдв",
//     "Fear ЁЯШи",
//     "Happy ЁЯШК",
//     "Neutral ЁЯШР",
//     "Sad ЁЯШн",
//     "Surprise ЁЯШ▓",
//   ];

//   @override
//   void initState() {
//     super.initState();
//     _initializeServices();
//   }

//   Future<void> _initializeServices() async {
//     _speech = stt.SpeechToText();
//     await _initializeCamera();
//     _faceDetector = FaceDetector(
//       options: FaceDetectorOptions(
//         enableClassification: true,
//         performanceMode: FaceDetectorMode.fast,
//       ),
//     );
//     await _loadModel();
//   }

//   Future<void> _initializeCamera() async {
//     try {
//       final cameras = await availableCameras();
//       final frontCamera = cameras.firstWhere(
//         (c) => c.lensDirection == CameraLensDirection.front,
//       );

//       _cameraController = CameraController(
//         frontCamera,
//         ResolutionPreset.low,
//         enableAudio: false,
//       );

//       await _cameraController!.initialize();
//       if (mounted) setState(() {});
//     } catch (e) {
//       debugPrint('Camera Error: $e');
//     }
//   }

//   Future<void> _loadModel() async {
//     try {
//       _interpreter = await Interpreter.fromAsset('assets/fer2013_model.tflite');
//       _interpreter!.allocateTensors();
//     } catch (e) {
//       debugPrint('Model Error: $e');
//     }
//   }

//   Future<void> _toggleAnalysis() async {
//     if (_isAnalyzing) {
//       await _stopAnalysis();
//     } else {
//       await _startAnalysis();
//     }
//   }

//   Future<void> _startAnalysis() async {
//     setState(() {
//       _isAnalyzing = true;
//       _stressLevel = "Analyzing...";
//       _detectedText = "";
//     });

//     if (await _speech.initialize()) {
//       _speech.listen(
//         onResult: (result) {
//           if (result.finalResult) {
//             setState(() => _detectedText = result.recognizedWords);
//           }
//         },
//       );
//     }

//     _cameraController?.startImageStream((image) {
//       if (_isAnalyzing &&
//           (_lastProcessingTime == null ||
//               DateTime.now().difference(_lastProcessingTime!) >
//                   const Duration(milliseconds: 500))) {
//         _processFrame(image);
//         _lastProcessingTime = DateTime.now();
//       }
//     });
//   }

//   Future<void> _stopAnalysis() async {
//     _speech.stop();
//     _cameraController?.stopImageStream();
//     final result = await _calculateStress();
//     setState(() {
//       _isAnalyzing = false;
//       _stressLevel = result;
//     });
//   }

//   Future<void> _processFrame(CameraImage image) async {
//     try {
//       final inputImage = InputImage.fromBytes(
//         bytes: _concatImagePlanes(image.planes),
//         inputImageData: InputImageData(
//           size: Size(image.width.toDouble(), image.height.toDouble()),
//           imageRotation: InputImageRotation.rotation0deg,
//           inputImageFormat: InputImageFormat.nv21,
//           planeData:
//               image.planes
//                   .map(
//                     (plane) => InputImagePlaneMetadata(
//                       bytesPerRow: plane.bytesPerRow,
//                       height: plane.height,
//                       width: plane.width,
//                     ),
//                   )
//                   .toList(),
//         ),
//       );

//       final faces = await _faceDetector.processImage(inputImage);
//       if (faces.isNotEmpty) setState(() {});
//     } catch (e) {
//       debugPrint('Frame Processing Error: $e');
//     }
//   }

//   Uint8List _concatImagePlanes(List<Plane> planes) {
//     final bytes = <int>[];
//     for (final plane in planes) {
//       bytes.addAll(plane.bytes);
//     }
//     return Uint8List.fromList(bytes);
//   }

//   Future<String> _calculateStress() async {
//     int stressScore = 0;

//     final textScore = _sentiment.analysis(_detectedText)['score'] ?? 0;
//     if (textScore < 0) stressScore += 1;

//     try {
//       final imageFile = File((await _cameraController!.takePicture()).path);
//       final processedImage = img.copyResize(
//         img.decodeImage(imageFile.readAsBytesSync())!,
//         width: 48,
//         height: 48,
//       );

//       final input = _prepareModelInput(processedImage);
//       final output = List.filled(7, 0.0).reshape([1, 7]);
//       _interpreter?.run(input, output);

//       final emotionIndex = output[0].indexOf(
//         output[0].reduce((a, b) => a > b ? a : b),
//       );
//       if (![
//         "Happy ЁЯШК",
//         "Neutral ЁЯШР",
//         "Surprise ЁЯШ▓",
//       ].contains(_emotions[emotionIndex])) {
//         stressScore += 1;
//       }
//     } catch (e) {
//       debugPrint('Stress Calculation Error: $e');
//     }

//     return _getStressLevel(stressScore);
//   }

//   String _getStressLevel(int score) {
//     return score == 0
//         ? "Low Stress ЁЯШК"
//         : score == 1
//         ? "Moderate Stress ЁЯШР"
//         : "High Stress ЁЯШЯ";
//   }

//   String _getStressDialog(String stressLevel) {
//     switch (stressLevel) {
//       case "Low Stress ЁЯШК":
//         return "ЁЯМЯ Great! You seem to be handling things well. Keep up the positive mindset!";
//       case "Moderate Stress ЁЯШР":
//         return "ЁЯТб You're doing okay, but consider taking short breaks. Practice deep breathing or a quick walk.";
//       case "High Stress ЁЯШЯ":
//         return "тЪая╕П It's important to take care of yourself. Try relaxation techniques or talk to someone.";
//       default:
//         return "ЁЯМ▒ Take a moment to assess your well-being. Your health matters!";
//     }
//   }

//   List<List<List<List<double>>>> _prepareModelInput(img.Image image) {
//     return List.generate(
//       1,
//       (_) => List.generate(
//         48,
//         (y) => List.generate(48, (x) {
//           final pixel = image.getPixel(x, y);
//           return [(pixel.r + pixel.g + pixel.b) / 3.0 / 255.0];
//         }),
//       ),
//     );
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       appBar: AppBar(
//         title: const Text(
//           "ЁЯОд Voice & ЁЯУ╕ Face Stress Analysis",
//           style: TextStyle(
//             fontWeight: FontWeight.bold, // Added bold font weight
//           ),
//         ),
//         backgroundColor: const Color.fromARGB(255, 255, 255, 255),
//         elevation: 10,
//       ),
//       body: Container(
//         decoration: const BoxDecoration(
//           gradient: LinearGradient(
//             colors: [
//               Color.fromARGB(255, 38, 6, 93),
//               Color.fromARGB(255, 61, 29, 127),
//               Color.fromARGB(255, 41, 35, 75),
//             ],
//             begin: Alignment.topCenter,
//             end: Alignment.bottomCenter,
//           ),
//         ),
//         child: SingleChildScrollView(
//           child: ConstrainedBox(
//             constraints: BoxConstraints(
//               minHeight: MediaQuery.of(context).size.height,
//             ),
//             child: Column(
//               mainAxisAlignment: MainAxisAlignment.center,
//               children: [
//                 _cameraController != null &&
//                         _cameraController!.value.isInitialized
//                     ? SizedBox(
//                       height: 300,
//                       width: 300,
//                       child: ClipRRect(
//                         borderRadius: BorderRadius.circular(20),
//                         child: CameraPreview(_cameraController!),
//                       ),
//                     )
//                     : const Padding(
//                       padding: EdgeInsets.all(40.0),
//                       child: CircularProgressIndicator(color: Colors.white),
//                     ),
//                 const SizedBox(height: 30),
//                 ElevatedButton(
//                   onPressed: _toggleAnalysis,
//                   style: ElevatedButton.styleFrom(
//                     backgroundColor: Colors.lightGreen,
//                     padding: const EdgeInsets.symmetric(
//                       horizontal: 40,
//                       vertical: 15,
//                     ),
//                     shape: RoundedRectangleBorder(
//                       borderRadius: BorderRadius.circular(30),
//                     ),
//                   ),
//                   child: Text(
//                     _isAnalyzing ? "тП╣ Stop Analysis" : "тЦ╢ Start Analysis",
//                     style: const TextStyle(
//                       fontSize: 20,
//                       fontWeight: FontWeight.bold,
//                       color: Colors.black,
//                     ),
//                   ),
//                 ),
//                 const SizedBox(height: 30),
//                 Padding(
//                   padding: const EdgeInsets.symmetric(horizontal: 25.0),
//                   child: Container(
//                     padding: const EdgeInsets.all(20),
//                     margin: const EdgeInsets.only(bottom: 20),
//                     decoration: BoxDecoration(
//                       color: Colors.white.withOpacity(0.1),
//                       borderRadius: BorderRadius.circular(15),
//                     ),
//                     child: Column(
//                       children: [
//                         Text(
//                           "Detected Text: $_detectedText",
//                           textAlign: TextAlign.center,
//                           style: const TextStyle(
//                             fontSize: 18,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 20),
//                         Text(
//                           _stressLevel,
//                           style: const TextStyle(
//                             fontSize: 24,
//                             fontWeight: FontWeight.bold,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(height: 15),
//                         Padding(
//                           padding: const EdgeInsets.symmetric(horizontal: 10.0),
//                           child: Text(
//                             _getStressDialog(_stressLevel),
//                             textAlign: TextAlign.center,
//                             style: TextStyle(
//                               fontSize: 16,
//                               color: Colors.amber[200],
//                               fontStyle: FontStyle.italic,
//                             ),
//                           ),
//                         ),
//                       ],
//                     ),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//         ),
//       ),
//     );
//   }

//   @override
//   void dispose() {
//     _cameraController?.dispose();
//     _faceDetector.close();
//     _interpreter?.close();
//     super.dispose();
//   }
// }

